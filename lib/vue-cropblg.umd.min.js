(function(t,e){"object"===typeof exports&&"object"===typeof module?module.exports=e():"function"===typeof define&&define.amd?define([],e):"object"===typeof exports?exports["vue-cropblg"]=e():t["vue-cropblg"]=e()})("undefined"!==typeof self?self:this,function(){return function(t){var e={};function i(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return t[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=t,i.c=e,i.d=function(t,e,o){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},i.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(o,n,function(e){return t[e]}.bind(null,n));return o},i.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s="fb15")}({fb15:function(t,e,i){"use strict";var o;(i.r(e),"undefined"!==typeof window)&&((o=window.document.currentScript)&&(o=o.src.match(/(.+\/)[^\/]+\.js(\?.*)?$/))&&(i.p=o[1]));var n=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"mountNode",staticClass:"mount-node",staticStyle:{overflow:"hidden"},on:{touchstart:function(e){return t.handleStart(e)},touchmove:function(e){return t.handleMove(e)}}},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.noImage,expression:"noImage"}],staticClass:"no-image-file",staticStyle:{height:"100%",display:"flex","justify-content":"center","align-items":"center","flex-wrap":"wrap"},on:{click:t.inputHandle,touchstart:function(t){t.stopPropagation()},touchmove:function(t){t.stopPropagation()}}},[t._t("placeholder",[i("span",[t._v("暂时没有图片,请选择图像")])]),i("div",{staticStyle:{display:"none"}},[i("input",{attrs:{type:"file",id:"file-input",accept:"image/jpeg,image/x-icon,image/png"},on:{change:t.uploadImg}}),t._t("defaultImgUrl")],2)],2)])},r=[],a={name:"crop",props:["value","position","textWatermark","imageWatermark","defaultImgUrl","color","angle"],data(){return{noImage:!0,ctx:null,options:null,pixelRatio:null,scale:1,canvas:null,image:{},points:[],lines:[],cropper:{},startPoint:{},touchBar:{},nookSide:30,rotateAngle:0}},methods:{animation(t){if(t){const e=t.width,i=t.height,{width:o,height:n}=this.options;let r=e,a=i,s=1;e>o&&(r=o,s=r/e,a=s*i),a>n&&(a=n,s=a/i,r=s*e);const h=100;e<h&&(r=h,s=r/e,a=s*i),a<h&&(a=h,s=a/i,r=s*e),this.image={element:t,width:r,height:a,x:(o-r)/2,y:(n-a)/2,clientWidth:e,clientHeight:i},this.cropper={x:(o-r/2)/2,y:(n-a/2)/2,width:r/2,height:a/2},this.touchBar={x:o-60-14,y:10,width:60,height:60},this.scale=s,this.draw()}},draw(){const{width:t,height:e}=this.options;this.ctx.clearRect(0,0,t,e),this.fillBackground(),this.fillImage(),this.averageColor||(this.averageColor=this.getImageColor(this.ctx.getImageData(this.cropper.x,this.cropper.y,50,50).data)),this.updatePoint(),this.fillCropper(),this.angle&&this.drawTouchBar()},drawTouchBar(){const t=this.ctx,e=this.touchBar,i=this.color||this.averageColor,o=e.x+.6*e.width,n=e.y+.64*e.height,r=.41*e.width,a=6,s=.1*e.width,h=.18*e.width;if(t.lineWidth=2,t.fillStyle=i,t.fillRect(o-e.width/6,n-e.height/6,.43*e.width,.43*e.height),t.strokeStyle=i,t.beginPath(),t.arc(o,n,r,Math.PI/180*180,-Math.PI/2+a,!1),t.stroke(),a<2*Math.PI){const e=o+(r-s)*Math.sin(a),i=n-(r-s)*Math.cos(a),c=o+(r+s)*Math.sin(a),l=n-(r+s)*Math.cos(a),d=(e+c)/2+h*Math.sin(a+Math.PI/2),g=(i+l)/2-h*Math.cos(a+Math.PI/2);t.beginPath(),t.moveTo(d,g),t.lineTo(e,i),t.lineTo(c,l),t.fill()}},fillImage(){const t=this.image,e=this.ctx,i=this.rotateAngle||0;this.canvasRotate("img",e,t.element,i,t.x,t.y,t.width,t.height)},updatePoint(){const t=this.cropper,e=this.nookSide,i=t.x+t.width,o=t.y+t.height,n=i-e,r=o-e;this.points=[{x:t.x,y:t.y,width:e,height:e,diffX:0,diffY:0},{x:n,y:t.y,width:e,height:e,diffX:e,diffY:0},{x:n,y:r,width:e,height:e,diffX:e,diffY:e},{x:t.x,y:r,width:e,height:e,diffX:0,diffY:e}];const a=e/.7/2,s=a/2;this.lines=[{x:t.x,y:t.y-s,width:t.width,height:a},{x:i-s,y:t.y,width:a,height:t.height},{x:t.x,y:o-s,width:t.width,height:a},{x:t.x-s,y:t.y,width:a,height:t.height}]},fillCropper(){const t=this.ctx,e=this.cropper,i=this.points,o=this.color||this.averageColor;t.strokeStyle=o,t.lineWidth=2,t.strokeRect(e.x,e.y,e.width,e.height),t.fillStyle=o;const n=this.nookSide/8;i.forEach((e,i)=>{t.save(),t.translate(e.x+e.diffX,e.y+e.diffY),t.rotate(90*i*(Math.PI/180)),t.fillRect(-n,-n,e.height,2*n),t.fillRect(-n,-n,2*n,e.width),t.restore()})},fillBackground(){const{width:t,height:e}=this.options,i=this.ctx,o=30,n=Math.ceil(t/o),r=Math.ceil(e/o);i.save(),i.fillStyle="#ccc";for(let a=0;a<r;a++)for(let t=0;t<n;t++)(t+a)%2===0&&i.fillRect(t*o,a*o,o,o);i.fillStyle="rgba(0, 0, 0, .1)",i.fillRect(0,0,t,e),i.restore()},getNewCropper(t,e,i){return{cropperWidth:i.x+i.width-t,cropperHeight:i.y+i.height-e,cropperX:t-i.x,cropperY:e-i.y}},handlePointMove({x:t,y:e}){const i=this.cropper,o={},{cropperWidth:n,cropperHeight:r,cropperX:a,cropperY:s}=this.getNewCropper(t,e,i);switch(this.index){case 0:o.width=n,o.height=r,o.x=t,o.y=e;break;case 1:o.width=a,o.height=r,o.y=e;break;case 3:o.width=n,o.height=s,o.x=t;break;case 2:o.width=a,o.height=s;break;default:break}this.renderCropper(o)},handleLineMove({x:t,y:e}){const i=this.cropper,o={},{cropperWidth:n,cropperHeight:r,cropperX:a,cropperY:s}=this.getNewCropper(t,e,i);switch(this.index){case 3:o.width=n,o.x=t;break;case 0:o.height=r,o.y=e;break;case 1:o.width=a;break;case 2:o.height=s;break;default:break}this.renderCropper(o)},renderCropper(t){t.width<=4*this.nookSide||t.height<=4*this.nookSide||(this.cropper={...this.cropper,...t},this.draw())},handleImageMove({x:t,y:e}){const i=this.startPoint;this.image.x=t-i.offsetX,this.image.y=e-i.offsetY,this.draw()},getCoordinateByEvent(t){const e=t.target.getBoundingClientRect(),i=t.touches[0],o={x:i.clientX-e.left,y:i.clientY-e.top},{width:n,height:r}=this.options;if(!(o.x<=2||o.y<=2||o.x>=n-2||o.y>=r-2))return o},handleStart(t){if(t.preventDefault(),t.touches.length>1)return this.startTouches=t.touches,void(this.startPoint.type=null);this.startPoint=this.getPointByCoordinate(this.getCoordinateByEvent(t))},handleMove(t){t.preventDefault();const e=t.touches;if(e.length>1){const t=this.image;let i,o=this.startTouches;const n=this.scale;i=this.getDistance(e[0],e[1])/this.getDistance(o[0],o[1]),i=i<1?1/(1+i/80):1+Math.abs(i)/160,i*=n,this.scale=this.limit(i,.02,4);const r=t.clientWidth*this.scale,a=t.clientHeight*this.scale;return this.image.x+=(t.width-r)/2,this.image.y+=(t.height-a)/2,this.image.width=r,this.image.height=a,void this.draw()}const i=this.startPoint.type;i&&this.getCoordinateByEvent(t)&&this[i](this.getCoordinateByEvent(t))},checkRegion(t,e,i){return t>i.x&&t<i.x+i.width&&e>i.y&&e<i.y+i.height},getPointByCoordinate({x:t,y:e}){const i=this.image,o=this.touchBar;let n={},r=0;return this.checkRegion(t,e,o)?(this.rotateAngle=(this.rotateAngle+this.angle)%360,this.draw()):this.points.some((i,o)=>{return r=o,this.checkRegion(t,e,i)})?(n.type="handlePointMove",this.index=r):this.lines.some((i,o)=>{return r=o,this.checkRegion(t,e,i)})?(n.type="handleLineMove",this.index=r):this.checkRegion(t,e,i)&&(n.offsetX=t-i.x,n.offsetY=e-i.y,n.type="handleImageMove"),n},getDistance(t,e){const i=e.pageX-t.pageX,o=e.pageY-t.pageY;return Math.sqrt(i*i+o*o)},limit(t,e,i){return t<e?e:t>i?i:t},getImage(t="Base64",e="image/jpeg",i=1){if(this.noImage)return;const o=this.image,n=this.cropper,r=this.pixelRatio,a={Base64(t,e){return new Promise(i=>{i(t.toDataURL(e))})},Blob(t,e){return new Promise(i=>{t.toBlob(t=>{i(t)},e)})}},s=n.width*i,h=n.height*i;this.canvas||(this.canvas=document.createElement("canvas"),this.cCtx=this.canvas.getContext("2d"));const c=this.cCtx;this.canvas.width=s*r,this.canvas.height=h*r,c.scale(r,r),c.clearRect(0,0,s,h);const l=this.rotateAngle||0;return this.canvasRotate("img",c,o.element,l,(o.x-n.x)*i,(o.y-n.y)*i,o.width*i,o.height*i),new Promise((o,n)=>{if(!a[t])return void n("type = Blob || Base64");const[r="50%",l="50%",d=1,g=0]=this.position;if(this.imageWatermark){let n=new Image;return n.src=this.getFileSrc(this.imageWatermark),n.crossOrigin="anonymous",void(n.onload=(()=>{const p=n.width*d*i,f=n.height*d*i,u=(s-p)*parseInt(r)/100,m=(h-f)*parseInt(l)/100;this.canvasRotate("img",c,n,g,u,m,p,f),o(a[t](this.canvas,e))}))}if(this.textWatermark){const i=this.limit(12*d,12,100);c.font=i+"px Georgia";const n=this.textWatermark,p=c.measureText(n).width,f=(s-1.031*p)*parseInt(r)/100,u=(h-2.82*i)*parseInt(l)/100;return c.fillStyle=this.color||this.averageColor,"#ffffff"===c.fillStyle&&(c.fillStyle="#000"),this.canvasRotate("text",c,n,g,f,u,p,i),void o(a[t](this.canvas,e))}o(a[t](this.canvas,e))})},canvasRotate(t,e,i,o,n,r,a,s){e.save();const h=s/2,c=a/2;e.translate(n+c,r+h),e.rotate(Math.PI/180*o),"img"===t?e.drawImage(i,-c,-h,a,s):e.fillText(i,-c,-h),e.restore()},changeImage(t){this.noImage||(this.averageColor=null,t?this.createImage(t):this.inputHandle())},getPixelRatio(t){const e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e},uploadImg(t){this.createImage(t.target.files[0]),this.noImage=!1},getFileSrc(t){return"[object File]"===Object.prototype.toString.call(t)&&(t=window.URL.createObjectURL(t)),t},createImage(t){let e=new Image;e.crossOrigin="anonymous",e.src=this.getFileSrc(t),e.onload=(()=>{this.animation(e)})},inputHandle(){document.getElementById("file-input").click()},getImageColor(t){if(this.color)return this.color;let e=0,i=0,o=0;const n=50;for(var r=0;r<n;r++)for(var a=0;a<n;a++)e+=t[4*(n*r+a)],i+=t[4*(n*r+a)+1],o+=t[4*(n*r+a)+2];return e/=n*n,i/=n*n,o/=n*n,e=Math.round(e),i=Math.round(i),o=Math.round(o),`rgba(${255-e}, ${255-i}, ${255-o}, 1)`}},mounted(){const{mountNode:t}=this.$refs,{clientWidth:e,clientHeight:i}=t;this.options={width:e,height:i};let o=document.createElement("canvas");o.style.width=e+"px",o.style.height=i+"px",t.appendChild(o),this.ctx=o.getContext("2d");const n=this.pixelRatio=this.getPixelRatio(this.ctx);if(o.width=e*n,o.height=i*n,this.ctx.scale(n,n),this.defaultImgUrl||this.$slots.defaultImgUrl){const t=this.defaultImgUrl?this.defaultImgUrl:this.$slots.defaultImgUrl[0].data.attrs.src;this.createImage(t),this.noImage=!1}this.$emit("input",{getImage:this.getImage,changeImage:this.changeImage})}},s=a;function h(t,e,i,o,n,r,a,s){var h,c="function"===typeof t?t.options:t;if(e&&(c.render=e,c.staticRenderFns=i,c._compiled=!0),o&&(c.functional=!0),r&&(c._scopeId="data-v-"+r),a?(h=function(t){t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,t||"undefined"===typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),n&&n.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(a)},c._ssrRegister=h):n&&(h=s?function(){n.call(this,this.$root.$options.shadowRoot)}:n),h)if(c.functional){c._injectStyles=h;var l=c.render;c.render=function(t,e){return h.call(e),l(t,e)}}else{var d=c.beforeCreate;c.beforeCreate=d?[].concat(d,h):[h]}return{exports:t,options:c}}var c=h(s,n,r,!1,null,null,null),l=c.exports;const d=function(t){d.installed||(d.installed=!0,t.component(l.name,l))};"undefined"!==typeof window&&window.Vue&&d(window.Vue);var g={install:d,crop:l};i.d(e,"crop",function(){return l});e["default"]=g}})});
//# sourceMappingURL=vue-cropblg.umd.min.js.map