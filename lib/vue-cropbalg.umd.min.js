(function(t,e){"object"===typeof exports&&"object"===typeof module?module.exports=e():"function"===typeof define&&define.amd?define([],e):"object"===typeof exports?exports["vue-cropbalg"]=e():t["vue-cropbalg"]=e()})("undefined"!==typeof self?self:this,function(){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var h=e[n]={i:n,l:!1,exports:{}};return t[n].call(h.exports,h,h.exports,i),h.l=!0,h.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)i.d(n,h,function(e){return t[e]}.bind(null,h));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s="fb15")}({fb15:function(t,e,i){"use strict";var n;(i.r(e),"undefined"!==typeof window)&&((n=window.document.currentScript)&&(n=n.src.match(/(.+\/)[^\/]+\.js(\?.*)?$/))&&(i.p=n[1]));var h=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"mountNode",staticClass:"mount-node",staticStyle:{overflow:"hidden"},on:{touchstart:function(e){return t.handleStart(e)},touchmove:function(e){return t.handleMove(e)}}},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.noImage,expression:"noImage"}],staticClass:"no-image-file",staticStyle:{height:"100%",display:"flex","justify-content":"center","align-items":"center","background-color":"#f1f3f5","flex-wrap":"wrap"},on:{click:t.inputHandle,touchstart:function(t){t.stopPropagation()},touchmove:function(t){t.stopPropagation()}}},[t._t("placeholder",[i("span",[t._v("暂时没有图片,请选择图像")])]),i("div",{staticStyle:{display:"none"}},[i("input",{attrs:{type:"file",id:"file-input",accept:"image/jpeg,image/x-icon,image/png"},on:{change:t.uploadImg}}),t._t("initial"),t._t("watermark")],2)],2)])},o=[],s={name:"crop",props:["imgaeFile","value","position"],data(){return{noImage:!0,ctx:null,options:null,arg:null,scale:1,canvas:null,image:{},points:[],lines:[],cropper:{},startPoint:{},nook:{w:27,h:27}}},methods:{animation(t){if(t){const e=t.width,i=t.height,{width:n,height:h}=this.options;let o=e,s=i,a=1;e>n&&(o=n,a=o/e,s=a*i),s>h&&(s=h,a=s/i,o=a*e),this.image={element:t,width:o,height:s,x:(n-o)/2,y:(h-s)/2,clientWidth:e,clientHeight:i},this.cropper={x:(n-o/2)/2,y:(h-s/2)/2,width:o/2,height:s/2},this.scale=a,this.draw()}},draw(){const{width:t,height:e}=this.options;this.ctx.clearRect(0,0,t,e),this.fillBackground(),this.fillImage(),this.updatePoint(),this.fillCropper()},fillImage(){const t=this.image,e=this.ctx;e.drawImage(t.element,t.x,t.y,t.width,t.height)},updatePoint(){const t=this.cropper;let{w:e,h:i}=this.nook;this.points=[{x:t.x-3,y:t.y-3,width:e,height:i},{x:t.x+t.width-e+3,y:t.y-3,width:e,height:i},{x:t.x-3,y:t.y+t.height-i+3,width:e,height:i},{x:t.x+t.width-e+3,y:t.y+t.height-i+3,width:e,height:i}],e/=.7,i/=.7,this.lines=[{x:t.x,y:t.y-e/2,width:t.width,height:i},{x:t.x+t.width-e+e/2,y:t.y,width:e,height:t.height},{x:t.x,y:t.y+t.height-i+e/2,width:t.width,height:i},{x:t.x-e/2,y:t.y,width:e,height:t.height}]},fillCropper(){const t=this.ctx,e=this.cropper,i=this.points;t.strokeStyle="#fff",t.lineWidth=3,t.strokeRect(e.x,e.y,e.width,e.height),t.fillStyle="#fff",t.fillRect(i[0].x,i[0].y,i[0].width/4,i[0].height),t.fillRect(i[0].x,i[0].y,i[0].width,i[0].height/4),t.fillRect(i[1].x+i[1].width/4*3,i[1].y,i[1].width/4,i[1].height),t.fillRect(i[1].x,i[1].y,i[1].width,i[1].height/4),t.fillRect(i[2].x,i[2].y,i[2].width/4,i[2].height),t.fillRect(i[2].x,i[2].y+i[2].width/4*3,i[2].width,i[2].height/4),t.fillRect(i[3].x+i[3].width/4*3,i[3].y,i[3].width/4,i[3].height),t.fillRect(i[3].x,i[3].y+i[3].width/4*3,i[3].width,i[3].height/4)},fillBackground(){const{width:t,height:e}=this.options,i=this.ctx,n=15,h=Math.ceil(t/n),o=Math.ceil(e/n);i.save(),i.fillStyle="#ccc";for(let s=0;s<o;s++)for(let t=0;t<h;t++)(t+s)%2===0&&i.fillRect(t*n,s*n,n,n);i.fillStyle="rgba(0,0,0,0.1)",i.fillRect(0,0,t,e),i.restore()},handlePointMove({x:t,y:e}){const i=this.cropper,n={};switch(this.index){case 3:n.width=t-i.x,n.height=e-i.y;break;case 0:n.width=i.x+i.width-t,n.height=i.y+i.height-e,n.x=t,n.y=e;break;case 1:n.width=t-i.x,n.height=i.y+i.height-e,n.y=e;break;case 2:n.width=i.x+i.width-t,n.height=e-i.y,n.x=t;break;default:break}n.width<=2*this.nook.w||n.height<=2*this.nook.h||(this.cropper={...this.cropper,...n},this.draw())},handleImageMove({x:t,y:e}){const i=this.startPoint;this.image.x=t-i.offsetX,this.image.y=e-i.offsetY,this.draw()},handleLineMove({x:t,y:e}){const i=this.cropper,n={};switch(this.index){case 3:n.width=i.x+i.width-t,n.x=t;break;case 0:n.height=i.y+i.height-e,n.y=e;break;case 1:n.width=t-i.x;break;case 2:n.height=e-i.y;break;default:break}n.width<=30||n.height<=30||(this.cropper={...this.cropper,...n},this.draw())},handleCropperMove({x:t,y:e}){const{width:i,height:n}=this.options,h=this.startPoint,o=h.offsetX,s=h.offsetY,a=i-this.cropper.width,r=n-this.cropper.height;let c=t-o,l=e-s;this.cropper.x=this.limit(c,0,a),this.cropper.y=this.limit(l,0,r),this.draw()},getCoordinateByEvent(t){const e=t.target.getBoundingClientRect(),i=t.touches[0];return{x:i.clientX-e.left,y:i.clientY-e.top}},handleStart(t){if(t.touches.length>1)return this.startTouches=t.touches,void(this.startPoint.type=null);this.startPoint=this.getPointByCoordinate(this.getCoordinateByEvent(t))},handleMove(t){const e=t.touches;if(e.length>1){t.preventDefault();const i=this.image;let n,h=this.startTouches,o=i.clientWidth,s=i.clientHeight;const a=this.scale;return n=this.getDistance(e[0],e[1])/this.getDistance(h[0],h[1]),n=n<1?1/(1+n/80):1+Math.abs(n)/160,n*=a,this.scale=this.limit(n,.02,4),o*=n,s*=n,i.x+=(i.width-o)/2,i.y+=(i.height-s)/2,i.width=o,i.height=s,void this.draw()}const i=this.startPoint.type;i&&this[i](this.getCoordinateByEvent(t))},getPointByCoordinate({x:t,y:e}){const i=this.image;let n={},h=0;return this.points.some((i,n)=>{return h=n,t>i.x&&t<i.x+i.width&&e>i.y&&e<i.y+i.height})?(n.type="handlePointMove",this.index=h):this.lines.some((i,n)=>{return h=n,t>i.x&&t<i.x+i.width&&e>i.y&&e<i.y+i.height})?(n.type="handleLineMove",this.index=h):i&&t>i.x&&t<i.x+i.width&&e>i.y&&e<i.y+i.height&&(n.offsetX=t-i.x,n.offsetY=e-i.y,n.type="handleImageMove"),n},getDistance(t,e){const i=e.pageX-t.pageX,n=e.pageY-t.pageY;return Math.sqrt(i*i+n*n)},limit(t,e,i){return t<e?e:t>i?i:t},getImage(t="Base64",e="image/jpeg",i=1){if(this.noImage)return;const n=this.image,h=this.cropper,o={Base64(t,e){return new Promise(i=>{i(t.toDataURL(e))})},Blob(t,e){return new Promise(i=>{t.toBlob(t=>{i(t)},e)})}},s=h.width*i,a=h.height*i;return this.canvas||(this.canvas=document.createElement("canvas"),this.cCtx=this.canvas.getContext("2d")),this.canvas.width=s,this.canvas.height=a,this.cCtx.clearRect(0,0,s,a),this.cCtx.drawImage(n.element,(n.x-h.x)*i,(n.y-h.y)*i,n.width*i,n.height*i),new Promise((i,n)=>{if(!o[t])return void n("type= Blob || Base64");if(!this.$slots.watermark)return void i(o[t](this.canvas,e));const[h="50%",r="50%",c=1]=this.position,l=this.$slots.watermark&&"img"===this.$slots.watermark[0].tag;if(l){let n=new Image;return n.src=this.$slots.watermark[0].data.attrs.src,n.crossOrigin="anonymous",void(n.onload=(()=>{const l=n.width*c*this.scale,d=n.height*c*this.scale;this.cCtx.drawImage(n,(s-l)*parseInt(h)/100,(a-d)*parseInt(r)/100,l,d),i(o[t](this.canvas,e))}))}const d=12*c,g=this.$slots.watermark[0].text.trim()||"请直接放文字",p=this.cCtx.measureText(g).width,f=(s-2*p)*parseInt(h)/100,u=(a+d/2)*parseInt(r)/100,x=this.cCtx.getImageData(f,u,1,1).data;this.cCtx.font=12*c+"px Georgia",this.cCtx.fillStyle=`rgba(${255-x[0]}, ${255-x[1]}, ${255-x[2]}, 1)`,"#ffffff"===this.cCtx.fillStyle&&(this.cCtx.fillStyle="#000"),this.cCtx.fillText(g,f,u),i(o[t](this.canvas,e))})},changeImage(t){this.noImage||(t?this.createImage(t):this.inputHandle())},getPixelRatio(t){const e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e},uploadImg(t){this.createImage(t.target.files[0]),this.noImage=!1},createImage(t){let e=new Image,i=t;"[object File]"===Object.prototype.toString.call(t)&&(i=window.URL.createObjectURL(t)),e.crossOrigin="anonymous",e.src=i,e.onload=(()=>{this.animation(e)})},inputHandle(){document.getElementById("file-input").click()}},mounted(){const{mountNode:t}=this.$refs,{clientWidth:e,clientHeight:i}=t;this.options={width:e,height:i};let n=document.createElement("canvas");n.style.width=e+"px",n.style.height=i+"px",t.appendChild(n),this.ctx=n.getContext("2d");const h=this.getPixelRatio(this.ctx);n.width=e*h,n.height=i*h,this.ctx.scale(h,h),this.$slots.initial&&(this.createImage(this.$slots.initial[0].data.attrs.src),this.noImage=!1),this.$emit("input",{getImage:this.getImage,changeImage:this.changeImage})}},a=s;function r(t,e,i,n,h,o,s,a){var r,c="function"===typeof t?t.options:t;if(e&&(c.render=e,c.staticRenderFns=i,c._compiled=!0),n&&(c.functional=!0),o&&(c._scopeId="data-v-"+o),s?(r=function(t){t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,t||"undefined"===typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),h&&h.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(s)},c._ssrRegister=r):h&&(r=a?function(){h.call(this,this.$root.$options.shadowRoot)}:h),r)if(c.functional){c._injectStyles=r;var l=c.render;c.render=function(t,e){return r.call(e),l(t,e)}}else{var d=c.beforeCreate;c.beforeCreate=d?[].concat(d,r):[r]}return{exports:t,options:c}}var c=r(a,h,o,!1,null,null,null),l=c.exports;const d=function(t){d.installed||(d.installed=!0,t.component(l.name,l))};"undefined"!==typeof window&&window.Vue&&d(window.Vue);var g={install:d,crop:l};i.d(e,"crop",function(){return l});e["default"]=g}})});
//# sourceMappingURL=vue-cropbalg.umd.min.js.map